name: Build Plugin

concurrency:
  group: build
  cancel-in-progress: true

on:
  push:
    branches:
      - main      # se il tuo branch Ã¨ main
      - master    # oppure master, nel dubbio
    paths-ignore:
      - '*.md'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Echo branch & SHA
        run: |
          echo "Triggered on ${{ github.ref }} (SHA ${{ github.sha }})"

      - name: Checkout sorgenti
        uses: actions/checkout@v3
        with:
          path: src

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('src/**/*.gradle*','src/**/gradle-wrapper.properties') }}

      - name: Build Plugin
        working-directory: src
        run: |
          chmod +x gradlew
          ./gradlew clean make makePluginsJson

      - name: Upload artefatti
        uses: actions/upload-artifact@v3
        with:
          name: plugin-builds
          path: |
            src/**/build/*.cs3
            src/**/build/plugins.json

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/master'

    steps:
      - name: Checkout branch builds
        uses: actions/checkout@v3
        with:
          ref: builds
          path: builds-repo

      - name: Download artefatti
        uses: actions/download-artifact@v3
        with:
          name: plugin-builds
          path: plugin-builds

      - name: Copia build su builds
        run: |
          cp plugin-builds/*.cs3 builds-repo/
          cp plugin-builds/plugins.json builds-repo/

      - name: Commit & Push su builds
        working-directory: builds-repo
        run: |
          git config user.email "actions@github.com"
          git config user.name  "GitHub Actions"
          git add .
          git commit -m "Build ${{ github.sha }}" || echo "No changes to commit"
          git push origin builds